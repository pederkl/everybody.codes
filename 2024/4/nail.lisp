(defparameter *demo-nails*
  '(3
    4
    7
    8))

(defparameter *demo-nails2*
  '(2
    4
    5
    6
    8))

(defparameter *part1-nails* '(14 18 12 16 15 10 7 12 10 10 11))

(defparameter *part2-nails* '(6413 5237 5834 2777 1551 3057 1971 5401 8999
                              9157 6407 9401 3066 3321 7610 9283 6816 1305
                              9052 2866 7020 4593 7478 3444 7612 5180 9284
                              3935 2429 7365 5779 8304 8562 5609 5690 9934
                              1763 8125 9182 1683 6821 7500 5338 1033 3960
                              3499 4363 6751 8707 1042 7047 9269 1339 1013
                              3582 3429 8609 2599 3341 2128 4312 1362 7828
                              3968 2253 2026 9309 2285 7946 3176 6758 9336
                              1916 4130 4346 1322 9462 4127 7381 4640 5304
                              7543 1551 2946 4663 7113 1307 9295 2411 3355
                              4188 4200 6381 5970 3166 8000 9715 2646 8976
                              1310 5675 3201 8633 9707 3029 4550 7953 3327
                              8908 6626 4851 5841 4874 6068 2872 2831 3851
                              2245 6950 9513 8601 3614 4595 4668 9709 8486
                              4747 1053 4904 5589 2553 3829 1324 3926 2876
                              7017 4648 8800 4653 1689 6055 8055 9748 2473
                              9874 6331 1258 7992 3947 2250 6695 4825 6378
                              8018 9131 9731 7930 5220 4964 1613 3974 4291
                              3403 3105 6785 1622 4045 4410 1728 9902 4550
                              5200 1438 5682 3291 9510 6642 5654 3813 3553
                              4082 7356 2040 2405 6684 2556 4972 2457 4055
                              7008 3822 5309 4082 9590 2711 9913 8525 2283
                              1432 9748))

(defparameter *part3-nails*
  '(27873135 27915292 27429585 27568996 27976297 27108626 27624750 27479862
    27072487 27372134 27140639 27930692 27812937 27285534 27863186 27277390
    27802806 27490493 27798119 27217171 27554662 27798821 27092900 27646912
    27971561 27365631 27324065 27052081 27790950 27622435 27585915 27160656
    27998092 27973239 27115045 27236066 27712837 27616926 27392004 27798596
    27303479 27419939 27762463 27072844 27924546 27707612 27979130 27147127
    27719943 27604333 27731593 27246639 27982770 27570537 27721274 27183278
    27823682 27628141 27600413 27593270 27156938 27817378 27132921 27812586
    27556167 27459724 27559341 27687541 27865296 27437222 27311536 27148208
    27192177 27359827 27672445 27828029 27111592 27559680 27298742 27264838
    27593456 27226176 27815947 27858117 27899523 27561447 27952137 27696908
    27432160 27828716 27048264 27844277 27390822 27471134 27172167 27973703
    27613756 27426928 27607196 27297114 27551526 27570753 27026154 27759872
    27250602 27920024 27503229 27305028 27220935 27102955 27721916 27553840
    27347111 27783419 27972840 27027805 27192431 27261743 27154042 27994444
    27931290 27419843 27911318 27656696 27130499 27935433 27811742 27657257
    27473359 27163372 27752859 27596714 27778798 27590940 27256319 27667725
    27816424 27047583 27392595 27066813 27550702 27470818 27817164 27356408
    27017532 27018488 27466069 27791672 27153366 27276238 27296438 27066503
    27601316 27024283 27926669 27592022 27663250 27916806 27219113 27909775
    27342746 27164807 27504751 27311032 27138612 27016891 27243076 27311835
    27840884 27759063 27811939 27591563 27283733 27943841 27384701 27436963
    27047597 27226085 27582822 27269216 27499258 27103283 27297992 27631184
    27950599 27399922 27696716 27349005 27239469 27901967 27247303 27892554
    27985692 27729549 27973642 27211534 27548777 27358724 27033691 27708890
    27983036 27243853 27823611 27074404 27202148 27119234 27146298 27172206
    27765771 27334974 27110062 27610402 27173907 27989617 27000558 27030547
    27797444 27549805 27388418 27323412 27224454 27941926 27424222 27844414
    27680225 27899302 27275510 27319873 27868713 27463763 27142250 27497221
    27347316 27056922 27711695 27106342 27429455 27852595 27874208 27197011
    27140546 27828750 27753631 27120459 27975139 27482172 27677173 27267320
    27947068 27784742 27558453 27406674 27336423 27154706 27283111 27171569
    27257370 27071232 27318369 27613954 27801101 27427861 27089892 27152578
    27570459 27552607 27034593 27444248 27703402 27845222 27883331 27638245
    27415200 27932906 27997640 27825546 27512768 27182505 27859136 27291980
    27543097 27380942 27653791 27645297 27669279 27403331 27070524 27975666
    27082396 27241964 27818759 27134967 27914570 27778031 27216702 27857880
    27950004 27919107 27204161 27319309 27896070 27060962 27994911 27065488
    27767353 27092049 27931272 27893987 27908075 27793258 27638964 27308483
    27115937 27066171 27136072 27481375 27724896 27424469 27649566 27788048
    27924935 27443047 27375234 27233860 27978191 27623850 27192505 27632174
    27128990 27198117 27737786 27399720 27889317 27330827 27521996 27370261
    27765164 27807121 27472404 27282324 27073478 27620408 27630296 27770784
    27369537 27885483 27058953 27689984 27925582 27912680 27827413 27573063
    27679141 27030297 27750964 27868693 27720340 27583777 27198689 27553891
    27197795 27131571 27115873 27528273 27961909 27486379 27609456 27112033
    27506432 27047083 27631196 27386602 27171368 27821302 27966224 27665368
    27881362 27720679 27929239 27017246 27729506 27777753 27089249 27285370
    27713404 27353675 27778353 27739947 27561375 27893427 27127376 27397598
    27208349 27355789 27162243 27516411 27181244 27427407 27305546 27633441
    27950132 27080723 27134804 27330259 27522989 27042350 27276655 27197864
    27792891 27481198 27933213 27442506 27587419 27527902 27947116 27737642
    27803475 27683734 27718051 27562346 27348348 27417240 27136877 27913503
    27106069 27903165 27390023 27839266 27013542 27016617 27438421 27823659
    27789753 27859733 27671041 27850143 27398316 27804291 27397341 27564972
    27397126 27235554 27528516 27177203 27668794 27100611 27113823 27794907
    27925410 27488856 27872065 27901355 27074190 27308588 27727341 27131357
    27933733 27104024 27506309 27288773 27864262 27180515 27162927 27546133
    27941297 27557344 27605573 27023301 27177485 27646379 27042718 27506049
    27457833 27604313 27243090 27637329 27924957 27796840 27849729 27125191
    27278359 27522413 27497443 27855620 27036739 27689339 27567897 27067123
    27963047 27176786 27036149 27175051 27594405 27489288 27496983 27867436
    27135576 27270475 27526145 27090131))

(defun min-nail (nails)
  (apply #'min nails))

(defun nail-diffs (target nails)
  (mapcar #'(lambda (n) (abs (- n target)))
          nails))

(defun total-leveling (nails &optional (target-fn #'min-nail))
  (reduce #'+ (nail-diffs (funcall target-fn nails) nails)))

(defun mean (numbers)
  (loop with count = 0
        with sum = 0
        for n in numbers
        do
           (incf count)
           (incf sum n)
        finally
        return (truncate (/ sum count))))

(defun median (numbers)
  (let* ((numbers (sort (copy-list numbers) #'<))
         (count (length numbers))
         (middle (ash count -1)))
    (elt numbers middle)))

(defun part3 ()
  (total-leveling *part3-nails* #'median))
